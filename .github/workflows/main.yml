name: Deploy via Public API

on:
  pull_request_target:
    types: [labeled]

jobs:
  deploy-via-api:
    if: contains(github.event.pull_request.labels.*.name, 'deploy')
    runs-on: ubuntu-latest

    steps:
      # 1. –°–∫–∞—á–∏–≤–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è (–æ–Ω–æ –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É)
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          # –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é—Ç—Å—è –≤—Å–µ –Ω—É–∂–Ω—ã–µ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç–∞
          pip install requests pydantic pyyaml

      # 2. –ó–∞–ø—É—Å–∫–∞–µ–º runner.py
      # –¢–µ–ø–µ—Ä—å –º—ã –ø–µ—Ä–µ–¥–∞–µ–º —Ç–æ—á–∫—É "." (—Ç–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è), —Ç–∞–∫ –∫–∞–∫ checkout —Ä–∞—Å–ø–∞–∫–æ–≤–∞–ª –∫—É—Ä—Å –ø—Ä—è–º–æ —Å—é–¥–∞.
      # PYTHONPATH=. –Ω—É–∂–µ–Ω, —á—Ç–æ–±—ã –ø–∏—Ç–æ–Ω –≤–∏–¥–µ–ª –ø–∞–∫–µ—Ç src –∫–∞–∫ –º–æ–¥—É–ª—å.
      - name: Upload Course
        env:
          LMS_API_URL: ${{ secrets.LMS_API_URL }}
          LMS_API_TOKEN: ${{ secrets.LMS_API_TOKEN }}
          # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â—É—é –ø–∞–ø–∫—É –≤ –ø—É—Ç–∏ –ø–æ–∏—Å–∫–∞ Python
          PYTHONPATH: .
        run: |
          echo "üöÄ Sending to Public API: $LMS_API_URL"
          # –ó–∞–ø—É—Å–∫–∞–µ–º —á–µ—Ä–µ–∑ -m –∏–∑ –∫–æ—Ä–Ω—è —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è. 
          # –¢–æ—á–∫–∞ –≤ –∫–æ–Ω—Ü–µ ‚Äî —ç—Ç–æ –ø—É—Ç—å –∫ –ø–∞–ø–∫–µ —Å –∫—É—Ä—Å–æ–º (—Ç–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞).
          python -m src.runner .
