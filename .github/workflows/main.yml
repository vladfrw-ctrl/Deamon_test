name: Deploy via Public API

on:
  pull_request_target:
    types: [labeled]

jobs:
  deploy-via-api:
    if: contains(github.event.pull_request.labels.*.name, 'deploy')
    runs-on: ubuntu-latest

    steps:
      # 1. –°–∫–∞—á–∏–≤–∞–µ–º –í–°–Å –∏–∑ –≤–µ—Ç–∫–∏ Pull Request
      - uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install requests pydantic pyyaml

      # 2. –ó–∞–ø—É—Å–∫–∞–µ–º runner.py –ò–ó –ü–ê–ü–ö–ò parser
      # –ú—ã –ø–µ—Ä–µ—Ö–æ–¥–∏–º –≤ –ø–∞–ø–∫—É (cd parser) –∏ —É–∫–∞–∑—ã–≤–∞–µ–º –ø—É—Ç—å –∫ –∞—Ä—Ö–∏–≤—É –Ω–∞ —É—Ä–æ–≤–µ–Ω—å –≤—ã—à–µ (../*.zip)
      - name: Upload Course
        env:
          LMS_API_URL: ${{ secrets.LMS_API_URL }}
          LMS_API_TOKEN: ${{ secrets.LMS_API_TOKEN }}
        run: |
          echo "üöÄ Sending to Public API: $LMS_API_URL"
          cd parser
          python runner.py ../*.zip